@page "/kalender"
@attribute [Authorize]
@rendermode InteractiveServer
@layout AppLayout

<div class="app-frame">
    <div class="home-container">
        <div class="header-with-back">
            <button class="zurueck-wrapper" @onclick='() => NavigateTo("/dashboard")'>
                <img src="images/zurueck.png" alt="Zurück" class="zurueck-button" />
            </button>
            <h2 class="greeting">
                <i class="bi bi-calendar3"></i> Termine
            </h2>
        </div>
        <button class="btn btn-primary" @onclick="OpenAddModal">
            <i class="bi bi-plus-circle"></i> Neuer Termin
        </button>
        @if (isLoading)
        {
            <div class="loading-state">
                <p>Lade Termine...</p>
            </div>
        }
        else if (termine == null || !termine.Any())
        {
            <div class="no-appointments">
                <p>Es wurden noch keine Termine eingetragen</p>
                <button class="primary-button" @onclick='() => NavigateTo("/record")'>
                    Termin aufnehmen
                </button>
            </div>
        }
        else
        {
            <div class="termin-list">
                @foreach (var termin in termine)
    {
        var status = GetDueStatus(termin);

        <div class="termin-item @(status) @(selectedTermin?.AppointmentId == termin.AppointmentId ? "active" : "")"
             @onclick="() => SelectTermin(termin)">
            <div class="termin-date">
                @termin.AppointmentDateTime.ToLocalTime().ToString("dddd dd. MMM", new System.Globalization.CultureInfo("de-DE"))
            </div>
            <div class="termin-time">
                @termin.AppointmentDateTime.ToLocalTime().ToString("HH:mm")
            </div>
        </div>
    }
            </div>

            @if (selectedTermin != null)
            {
                <div class="termin-detail">
                    <!-- Action Buttons -->
                    <div class="termin-actions">
                        <button class="btn-edit" @onclick="OpenEditModal" title="Bearbeiten">
                            <i class="bi bi-pencil-fill"></i>
                        </button>
                        <button class="btn-delete" @onclick="OpenDeleteConfirm" title="Löschen">
                            <i class="bi bi-trash-fill"></i>
                        </button>
                    </div>

                    @if (string.IsNullOrWhiteSpace(selectedTermin.Title))
                    {
                        <div class="no-info">
                            <i class="bi bi-plus-square-fill"></i>
                            <p>Es wurden noch keine Informationen zu dem Termin eingetragen</p>
                        </div>
                    }
                    else
                    {
                        <div class="termin-info">
                            <i class="bi bi-calendar-check-fill"></i>
                            <h4>@selectedTermin.Title</h4>
                            <p class="termin-zeit">
                                <i class="bi bi-clock"></i>
                                @selectedTermin.AppointmentDateTime.ToLocalTime().ToString("HH:mm")
                            </p>
                            @if (!string.IsNullOrEmpty(selectedTermin.Location))
                            {
                                <p class="termin-adresse">
                                    <i class="bi bi-geo-alt"></i>
                                    @selectedTermin.Location
                                </p>
                            }
                            @if (!string.IsNullOrEmpty(selectedTermin.Description))
                            {
                                <p class="termin-beschreibung">
                                    @selectedTermin.Description
                                </p>
                            }
                            @if (!string.IsNullOrEmpty(selectedTermin.AttendeeNames))
                            {
                                <p class="termin-teilnehmer">
                                    <i class="bi bi-people"></i>
                                    @selectedTermin.AttendeeNames
                                </p>
                            }
                            @if (selectedTermin.DurationMinutes.HasValue)
                            {
                                <p class="termin-dauer">
                                    <i class="bi bi-hourglass"></i>
                                    @selectedTermin.DurationMinutes Minuten
                                </p>
                            }
                        </div>
                    }
                </div>
            }

            <!-- Edit Modal -->
            @if (showEditModal)
            {
                <div class="modal-overlay" @onclick="CloseEditModal">
                    <div class="modal-content" @onclick:stopPropagation="true">
                        <div class="modal-header">
                            <h3>Termin bearbeiten</h3>
                            <button class="close-btn" @onclick="CloseEditModal">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            @if (!string.IsNullOrEmpty(errorMessage))
                            {
                                <div class="error-message">@errorMessage</div>
                            }
                            <div class="form-group">
                                <label>Titel *</label>
                                <input type="text" @bind="editTermin.Title" class="form-control" />
                            </div>
                            <div class="form-group">
                                <label>Datum und Uhrzeit *</label>
                                <input type="datetime-local" @bind="editTermin.AppointmentDateTime" class="form-control" />
                            </div>
                            <div class="form-group">
                                <label>Beschreibung</label>
                                <textarea @bind="editTermin.Description" class="form-control" rows="3"></textarea>
                            </div>
                            <div class="form-group">
                                <label>Ort</label>
                                <input type="text" @bind="editTermin.Location" class="form-control" />
                            </div>
                            <div class="form-group">
                                <label>Teilnehmer</label>
                                <input type="text" @bind="editTermin.AttendeeNames" class="form-control" />
                            </div>
                            <div class="form-group">
                                <label>Dauer (Minuten)</label>
                                <input type="number" @bind="editTermin.DurationMinutes" class="form-control" />
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" @onclick="CloseEditModal">Abbrechen</button>
                            <button class="btn-primary" @onclick="SaveEditTermin">Speichern</button>
                        </div>
                    </div>
                </div>
            }

            <!-- Delete Confirmation Modal -->
            @if (showDeleteConfirm)
            {
                <div class="modal-overlay" @onclick="CloseDeleteConfirm">
                    <div class="modal-content modal-small" @onclick:stopPropagation="true">
                        <div class="modal-header">
                            <h3>Termin löschen?</h3>
                        </div>
                        <div class="modal-body">
                            <p>Möchten Sie den Termin "<strong>@selectedTermin?.Title</strong>" wirklich löschen?</p>
                            <p class="warning-text">Diese Aktion kann nicht rückgängig gemacht werden.</p>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" @onclick="CloseDeleteConfirm">Abbrechen</button>
                            <button class="btn-danger" @onclick="ConfirmDelete">Löschen</button>
                        </div>
                    </div>
                </div>
            }
        }
    </div>

    @if (showAddModal)
    {
        <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Neuer Termin</h5>
                        <button type="button" class="btn-close" @onclick="CloseAddModal"></button>
                    </div>
                    <div class="modal-body">
                        @if (!string.IsNullOrEmpty(errorMessage))
                        {
                            <div class="alert alert-danger">@errorMessage</div>
                        }

                        <div class="mb-3">
                            <label class="form-label">Titel *</label>
                            <input type="text" class="form-control" @bind="newTermin.Title" placeholder="z.B. Arzttermin" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Datum und Uhrzeit *</label>
                            <input type="datetime-local" class="form-control" @bind="newTermin.AppointmentDateTime" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Beschreibung</label>
                            <textarea class="form-control" rows="3" @bind="newTermin.Description" placeholder="Optional"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Ort</label>
                            <input type="text" class="form-control" @bind="newTermin.Location" placeholder="Optional" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Dauer (Minuten)</label>
                            <input type="number" class="form-control" @bind="newTermin.DurationMinutes" placeholder="Optional" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Teilnehmer</label>
                            <input type="text" class="form-control" @bind="newTermin.AttendeeNames" placeholder="Optional, z.B. Dr. Schmidt" />
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CloseAddModal">Abbrechen</button>
                        <button type="button" class="btn btn-primary" @onclick="SaveNewTermin">Speichern</button>
                    </div>
                </div>
            </div>
        </div>
    }
</div>