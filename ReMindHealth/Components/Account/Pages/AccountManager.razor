@page "/Account/Manage"
@attribute [Authorize]
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Authorization
@using ReMindHealth.Application.DTOs.Responses
@rendermode InteractiveServer

<PageTitle>Kontoeinstellungen</PageTitle>

<div class="account-container">
    <div class="account-card">
        <button class="zurueck-wrapper" @onclick='() => GoBack()'>
            <img src="images/zurueck.png" alt="Zurück" class="zurueck-button" />
        </button>

        <!-- Header -->
        <div class="account-header">
            <h1>Kontoeinstellungen</h1>
        </div>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger">
                @errorMessage
            </div>
        }

        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="alert alert-success">
                @successMessage
            </div>
        }

        @if (isLoading)
        {
            <div class="loading-spinner">Lädt...</div>
        }
        else
        {
            <!-- Profile Section -->
            <div class="settings-section">
                <h2>Profil</h2>
                <div class="info-row">
                    <span class="info-label">E-Mail</span>
                    <span class="info-value">@currentUser?.Email</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Vorname</span>
                    <span class="info-value">@(string.IsNullOrEmpty(currentUser?.FirstName) ? "Nicht angegeben" : currentUser.FirstName)</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Nachname</span>
                    <span class="info-value">@(string.IsNullOrEmpty(currentUser?.LastName) ? "Nicht angegeben" : currentUser.LastName)</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Mitglied seit</span>
                    <span class="info-value">@currentUser?.CreatedAt.ToString("dd.MM.yyyy")</span>
                </div>
            </div>

            <!-- Edit Profile Section -->
            <div class="settings-section">
                <h2>Profil bearbeiten</h2>
                <EditForm Model="ProfileInput" OnValidSubmit="UpdateProfile" FormName="profile">
                    <DataAnnotationsValidator />

                    <div class="form-group">
                        <label>Vorname</label>
                        <InputText @bind-Value="ProfileInput.FirstName" class="form-control" placeholder="Vorname" />
                        <ValidationMessage For="() => ProfileInput.FirstName" class="text-danger" />
                    </div>

                    <div class="form-group">
                        <label>Nachname</label>
                        <InputText @bind-Value="ProfileInput.LastName" class="form-control" placeholder="Nachname" />
                        <ValidationMessage For="() => ProfileInput.LastName" class="text-danger" />
                    </div>

                    <button type="submit" class="btn-primary" disabled="@isSubmitting">
                        @if (isSubmitting)
                        {
                            <span>Wird gespeichert...</span>
                        }
                        else
                        {
                            <span>Profil aktualisieren</span>
                        }
                    </button>
                </EditForm>
            </div>

            <!-- Change Password Section -->
            <div class="settings-section">
                <h2>Passwort ändern</h2>
                <EditForm Model="PasswordInput" OnValidSubmit="ChangePassword" FormName="password">
                    <DataAnnotationsValidator />

                    <div class="form-group">
                        <label>Aktuelles Passwort</label>
                        <InputText type="password" @bind-Value="PasswordInput.OldPassword" class="form-control" placeholder="Aktuelles Passwort" />
                        <ValidationMessage For="() => PasswordInput.OldPassword" class="text-danger" />
                    </div>

                    <div class="form-group">
                        <label>Neues Passwort</label>
                        <InputText type="password" @bind-Value="PasswordInput.NewPassword" class="form-control" placeholder="Mindestens 6 Zeichen" />
                        <ValidationMessage For="() => PasswordInput.NewPassword" class="text-danger" />
                    </div>

                    <div class="form-group">
                        <label>Passwort bestätigen</label>
                        <InputText type="password" @bind-Value="PasswordInput.ConfirmPassword" class="form-control" placeholder="Passwort wiederholen" />
                        <ValidationMessage For="() => PasswordInput.ConfirmPassword" class="text-danger" />
                    </div>

                    <button type="submit" class="btn-primary" disabled="@isSubmitting">
                        @if (isSubmitting)
                        {
                            <span>Wird geändert...</span>
                        }
                        else
                        {
                            <span>Passwort ändern</span>
                        }
                    </button>
                </EditForm>
            </div>

            <!-- Danger Zone -->
            <div class="settings-section danger-zone">
                <h2>Gefahrenzone</h2>
                <p class="danger-warning">Diese Aktion kann nicht rückgängig gemacht werden.</p>

                @if (!showDeleteConfirmation)
                {
                    <button class="btn-danger" @onclick="ShowDeleteConfirmation">
                        Konto löschen
                    </button>
                }
                else
                {
                    <div class="delete-confirmation">
                        <p class="confirmation-text">Sind Sie sicher, dass Sie Ihr Konto löschen möchten? Alle Ihre Daten werden unwiderruflich gelöscht.</p>
                        <div class="confirmation-buttons">
                            <button class="btn-danger-confirm" @onclick="DeleteAccount" disabled="@isSubmitting">
                                @if (isSubmitting)
                                {
                                    <span>Wird gelöscht...</span>
                                }
                                else
                                {
                                    <span>Ja, Konto löschen</span>
                                }
                            </button>
                            <button class="btn-secondary" @onclick="CancelDelete">Abbrechen</button>
                        </div>
                    </div>
                }
            </div>
        }
    </div>
</div>